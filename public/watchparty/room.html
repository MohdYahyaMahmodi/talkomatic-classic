<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Talkomatic - Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="/socket.io/socket.io.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: "Roboto", sans-serif;
        background-color: #000000;
        color: #ffffff;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }
      .bg-primary {
        background-color: #000000;
      }
      .bg-secondary {
        background-color: #1a1a1a;
      }
      .bg-tertiary {
        background-color: #262626;
      }
      .bg-quaternary {
        background-color: #333333;
      }
      .text-primary {
        color: #ffffff;
      }
      .text-secondary {
        color: #aaaaaa;
      }
      .text-tertiary {
        color: #777777;
      }
      .accent-orange {
        color: #ff9800;
      }
      .bg-accent-orange {
        background-color: #ff9800;
      }
      .border-secondary {
        border-color: #333333;
      }
      .border-tertiary {
        border-color: #555555;
      }

      .btn-primary {
        background-color: #ff9800;
        color: white;
        transition: background-color 0.2s ease;
      }
      .btn-primary:hover {
        background-color: #e68900;
      }
      .btn-primary:disabled {
        background-color: #555555;
        cursor: not-allowed;
      }
      .btn-secondary {
        background-color: #333333;
        color: white;
        border: 1px solid #555555;
        transition: all 0.2s ease;
      }
      .btn-secondary:hover {
        background-color: #444444;
        border-color: #666666;
      }
      .input-field {
        background-color: #1a1a1a;
        border: 1px solid #333333;
        color: white;
        transition: border-color 0.2s ease;
      }
      .input-field:focus {
        outline: none;
        border-color: #ff9800;
        box-shadow: 0 0 0 1px #ff9800;
      }

      /* Video container with resizable capability */
      .video-container {
        position: relative;
        width: 100%;
        background-color: #1a1a1a;
        border: 2px solid #333333;
        border-radius: 8px;
        overflow: hidden;
        min-width: 300px;
        min-height: 169px; /* 300px * 9/16 */
        resize: both;
        aspect-ratio: 16/9;
      }
      .video-container iframe,
      .video-container > div {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      /* Mobile video container (non-resizable) */
      @media (max-width: 768px) {
        .video-container {
          resize: none;
          width: 100%;
          height: auto;
          border-radius: 0;
          border-left: none;
          border-right: none;
        }
      }

      /* User cards */
      .user-card {
        background-color: #262626;
        border: 1px solid #333333;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 8px;
        transition: background-color 0.2s ease;
      }
      .user-card:hover {
        background-color: #333333;
      }
      .host-badge {
        background-color: #ff9800;
        color: white;
        font-size: 10px;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 4px;
        text-transform: uppercase;
      }
      .online-indicator {
        width: 8px;
        height: 8px;
        background-color: #00ff00;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
      }

      /* Chat messages */
      .chat-message {
        margin-bottom: 12px;
        padding: 12px;
        background-color: #262626;
        border-radius: 8px;
        border-left: 3px solid transparent;
        word-wrap: break-word;
        animation: messageSlideIn 0.3s ease-out;
      }
      .chat-message.own {
        background-color: #333333;
        border-left-color: #ff9800;
      }
      .chat-message.system {
        background-color: #1a1a1a;
        border-left-color: #777777;
        text-align: center;
        font-style: italic;
        color: #aaaaaa;
      }
      .chat-message.error {
        background-color: #2d1b1b;
        border-left-color: #dc2626;
        color: #f87171;
      }
      .chat-message.success {
        background-color: #1b2d1b;
        border-left-color: #10b981;
        color: #6ee7b7;
      }
      @keyframes messageSlideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Rate limit indicator */
      .rate-limit-indicator {
        background-color: #dc2626;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        margin-bottom: 12px;
        text-align: center;
        animation: shake 0.5s ease-in-out;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }

      /* Custom scrollbars */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #1a1a1a;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #333333;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555555;
      }

      /* Loading overlay */
      .loading-overlay {
        background-color: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(4px);
      }

      /* Mobile tabs */
      .tab-button {
        flex: 1;
        padding: 12px;
        background-color: #262626;
        border: none;
        border-bottom: 2px solid transparent;
        color: #aaaaaa;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .tab-button.active {
        color: #ffffff;
        border-bottom-color: #ff9800;
        background-color: #333333;
      }
      .tab-button:hover {
        color: #ffffff;
        background-color: #333333;
      }

      /* Text wrapping for mobile */
      .room-title {
        word-wrap: break-word;
        word-break: break-word;
        hyphens: auto;
        overflow-wrap: break-word;
      }

      /* Video loading state */
      .video-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .desktop-left-panel {
          max-height: none;
          overflow-y: visible;
        }
        /* Ensure no horizontal overflow */
        .mobile-header {
          padding: 16px 12px;
        }
        .mobile-header .room-info {
          min-width: 0; /* Allow flex items to shrink */
          flex: 1;
        }
        .mobile-header .room-info h1 {
          font-size: 18px;
          line-height: 1.2;
        }
        .mobile-header .room-controls {
          flex-shrink: 0;
        }
      }

      /* Desktop left panel scrollable */
      .desktop-left-panel {
        max-height: calc(100vh - 80px); /* Subtract header height */
        overflow-y: auto;
      }

      /* Video resize handle styling */
      .video-container::-webkit-resizer {
        background-color: #ff9800;
        border-radius: 0 0 8px 0;
      }
    </style>
  </head>
  <body class="bg-primary text-primary">
    <!-- Loading Screen -->
    <div
      id="loadingScreen"
      class="fixed inset-0 loading-overlay flex items-center justify-center z-50"
    >
      <div class="text-center">
        <div
          class="w-12 h-12 border-2 border-gray-600 border-t-orange-500 rounded-full animate-spin mx-auto mb-4"
        ></div>
        <div class="text-lg font-medium">Joining room...</div>
        <div class="text-sm text-secondary mt-2">Setting up connection</div>
      </div>
    </div>

    <!-- Error Screen -->
    <div
      id="errorScreen"
      class="hidden fixed inset-0 bg-primary flex items-center justify-center z-50"
    >
      <div class="text-center max-w-md mx-auto px-6">
        <svg
          class="w-16 h-16 text-red-500 mx-auto mb-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        <h2 class="text-xl font-medium mb-2">Room Error</h2>
        <p id="errorMessage" class="text-secondary mb-6"></p>
        <button id="backToLobbyError" class="btn-primary px-6 py-3 rounded-lg">
          Back to Lobby
        </button>
      </div>
    </div>

    <!-- Main Room Interface -->
    <div
      id="roomInterface"
      class="hidden h-screen flex flex-col overflow-hidden"
    >
      <!-- Header -->
      <header class="bg-secondary border-b border-tertiary flex-shrink-0">
        <div class="hidden md:block px-6 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <button
                id="backToLobby"
                class="text-secondary hover:text-white transition-colors p-2 rounded-lg hover:bg-tertiary"
              >
                <svg
                  class="w-5 h-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M10 19l-7-7m0 0l7-7m-7 7h18"
                  />
                </svg>
              </button>
              <div class="room-info">
                <h1 id="roomName" class="text-xl font-medium room-title">
                  Room Name
                </h1>
                <div class="flex items-center space-x-4 text-sm text-secondary">
                  <span
                    >ID: <span id="roomId" class="text-white font-mono"></span
                  ></span>
                  <span id="userCount" class="text-white">0 users</span>
                </div>
              </div>
            </div>
            <div class="flex items-center space-x-4 room-controls">
              <span
                id="hostIndicator"
                class="hidden bg-orange-600 px-3 py-2 rounded-lg text-sm font-medium"
              >
                üëë You are host
              </span>
              <button
                id="shareRoom"
                class="btn-secondary px-4 py-2 rounded-lg text-sm"
              >
                <svg
                  class="w-4 h-4 inline mr-2"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"
                  />
                </svg>
                Share
              </button>
            </div>
          </div>
        </div>

        <!-- Mobile Header -->
        <div class="md:hidden mobile-header flex items-center justify-between">
          <div class="flex items-center space-x-3 room-info">
            <button
              id="backToLobbyMobile"
              class="text-secondary hover:text-white transition-colors p-2 rounded-lg hover:bg-tertiary"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 19l-7-7m0 0l7-7m-7 7h18"
                />
              </svg>
            </button>
            <div class="min-w-0 flex-1">
              <h1 id="roomNameMobile" class="text-lg font-medium room-title">
                Room Name
              </h1>
              <div class="flex items-center space-x-3 text-xs text-secondary">
                <span
                  >ID:
                  <span id="roomIdMobile" class="text-white font-mono"></span
                ></span>
                <span id="userCountMobile" class="text-white">0 users</span>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-2 room-controls">
            <span
              id="hostIndicatorMobile"
              class="hidden bg-orange-600 px-2 py-1 rounded text-xs font-medium"
            >
              üëë Host
            </span>
            <button
              id="shareRoomMobile"
              class="btn-secondary px-3 py-2 rounded-lg text-sm"
            >
              Share
            </button>
          </div>
        </div>
      </header>

      <!-- Desktop Layout -->
      <div class="hidden md:flex flex-1 overflow-hidden">
        <!-- Left Panel - Video and Controls (Scrollable) -->
        <div class="flex-1 flex flex-col desktop-left-panel">
          <!-- YouTube Video Section -->
          <div class="p-6">
            <div class="bg-secondary border border-tertiary rounded-lg p-4">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium">YouTube Player</h3>
                <div
                  id="hostControls"
                  class="hidden flex items-center space-x-2"
                >
                  <input
                    type="text"
                    id="youtubeUrl"
                    placeholder="Paste YouTube URL..."
                    class="input-field px-3 py-2 rounded-lg text-sm w-64"
                  />
                  <button
                    id="loadVideo"
                    class="btn-primary px-4 py-2 rounded-lg text-sm"
                  >
                    Load
                  </button>
                </div>
                <div id="nonHostMessage" class="hidden text-sm text-secondary">
                  Only the host can control video playback
                </div>
              </div>
              <div
                class="video-container"
                style="width: 640px; height: 360px"
                id="videoContainerDesktop"
              >
                <div id="youtubePlayer"></div>
              </div>
              <div class="mt-2 text-xs text-secondary">
                üí° Drag the bottom-right corner to resize the video player
              </div>
            </div>
          </div>

          <!-- Room Info Section -->
          <div class="px-6 pb-6">
            <div class="bg-secondary border border-tertiary rounded-lg p-4">
              <h3 class="text-lg font-medium mb-4">Room Information</h3>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span class="text-secondary">Room Type:</span>
                  <span class="ml-2 text-white">Text Chat + Video</span>
                </div>
                <div>
                  <span class="text-secondary">Created:</span>
                  <span id="roomCreated" class="ml-2 text-white">Just now</span>
                </div>
                <div>
                  <span class="text-secondary">Host:</span>
                  <span id="hostName" class="ml-2 text-white">-</span>
                </div>
                <div>
                  <span class="text-secondary">Users Online:</span>
                  <span id="userCountInfo" class="ml-2 text-white">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Panel - Chat and Users (Always Visible) -->
        <div class="w-96 bg-secondary border-l border-tertiary flex flex-col">
          <!-- Users Section -->
          <div class="p-4 border-b border-tertiary">
            <h4 class="text-sm font-medium text-secondary mb-3">
              Users in Room (<span id="userCountDesktop">0</span>)
            </h4>
            <div
              id="usersListDesktop"
              class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar"
            >
              <!-- Users will be populated here -->
            </div>
          </div>

          <!-- Chat Messages -->
          <div
            id="chatMessagesDesktop"
            class="flex-1 p-4 overflow-y-auto custom-scrollbar min-h-0"
          >
            <!-- Messages will be populated here -->
          </div>

          <!-- Rate Limit Indicator (Desktop) -->
          <div id="rateLimitDesktop" class="hidden px-4">
            <div class="rate-limit-indicator">
              Slow down! Try again in <span id="rateLimitTimerDesktop">0</span>s
            </div>
          </div>

          <!-- Chat Input -->
          <div class="p-4 border-t border-tertiary">
            <div class="flex space-x-2">
              <input
                type="text"
                id="chatInputDesktop"
                placeholder="Type a message..."
                class="input-field flex-1 px-3 py-3 rounded-lg text-sm"
                maxlength="500"
              />
              <button
                id="sendMessageDesktop"
                class="btn-primary px-4 py-3 rounded-lg text-sm"
              >
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile Layout -->
      <div class="md:hidden flex flex-col flex-1 overflow-hidden">
        <!-- Video Section (Full Width on Mobile) -->
        <div class="mobile-video-section">
          <div class="bg-secondary">
            <div class="p-4">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium">YouTube Player</h3>
                <div id="hostControlsMobile" class="hidden">
                  <button
                    id="loadVideoMobile"
                    class="btn-primary px-3 py-2 rounded-lg text-sm"
                  >
                    Load Video
                  </button>
                </div>
              </div>
            </div>
            <div class="video-container" id="videoContainerMobile">
              <div id="youtubePlayerMobile"></div>
            </div>
            <div id="hostControlsInputMobile" class="hidden p-4">
              <div class="flex space-x-2">
                <input
                  type="text"
                  id="youtubeUrlMobile"
                  placeholder="Paste YouTube URL..."
                  class="input-field flex-1 px-3 py-2 rounded-lg text-sm"
                />
                <button
                  id="loadVideoMobileBtn"
                  class="btn-primary px-4 py-2 rounded-lg text-sm"
                >
                  Load
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Mobile Tabs -->
        <div class="bg-secondary border-t border-tertiary">
          <div class="flex">
            <button id="chatTab" class="tab-button active">Chat</button>
            <button id="usersTab" class="tab-button">Users</button>
          </div>
        </div>

        <!-- Mobile Tab Content -->
        <div class="flex-1 overflow-hidden">
          <!-- Chat Tab -->
          <div id="chatTabContent" class="h-full flex flex-col">
            <div
              id="chatMessagesMobile"
              class="flex-1 p-4 overflow-y-auto custom-scrollbar min-h-0"
            >
              <!-- Messages will be populated here -->
            </div>

            <!-- Rate Limit Indicator (Mobile) -->
            <div id="rateLimitMobile" class="hidden px-4">
              <div class="rate-limit-indicator">
                Slow down! Try again in
                <span id="rateLimitTimerMobile">0</span>s
              </div>
            </div>

            <div class="p-4 border-t border-tertiary">
              <div class="flex space-x-2">
                <input
                  type="text"
                  id="chatInputMobile"
                  placeholder="Type a message..."
                  class="input-field flex-1 px-3 py-3 rounded-lg text-sm"
                  maxlength="500"
                />
                <button
                  id="sendMessageMobile"
                  class="btn-primary px-4 py-3 rounded-lg text-sm"
                >
                  <svg
                    class="w-4 h-4"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
                    />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Users Tab -->
          <div id="usersTabContent" class="hidden h-full overflow-y-auto">
            <div class="p-4">
              <h4 class="text-sm font-medium text-secondary mb-3">
                Users in Room (<span id="userCountMobileTab">0</span>)
              </h4>
              <div id="usersListMobile" class="space-y-2">
                <!-- Users will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- YouTube API Script -->
    <script>
      console.log("üì∫ Loading YouTube iframe API...");
      var tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName("script")[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    </script>

    <script>
      // Global variables
      let socket;
      let roomData = null;
      let currentUser = {};
      let youtubePlayer = null;
      let isHost = false;
      let allRoomUsers = [];
      let youtubeApiReady = false;
      let activeTab = "chat";
      let videoLoadingInProgress = false;

      // Rate limiting variables
      let messageHistory = [];
      let rateLimitActive = false;
      let rateLimitTimer = null;

      // DOM elements
      const loadingScreen = document.getElementById("loadingScreen");
      const errorScreen = document.getElementById("errorScreen");
      const errorMessage = document.getElementById("errorMessage");
      const roomInterface = document.getElementById("roomInterface");

      // Header elements (Desktop)
      const roomNameEl = document.getElementById("roomName");
      const roomIdEl = document.getElementById("roomId");
      const userCountEl = document.getElementById("userCount");
      const hostIndicator = document.getElementById("hostIndicator");
      const backToLobbyBtn = document.getElementById("backToLobby");
      const shareRoomBtn = document.getElementById("shareRoom");

      // Header elements (Mobile)
      const roomNameMobile = document.getElementById("roomNameMobile");
      const roomIdMobile = document.getElementById("roomIdMobile");
      const userCountMobile = document.getElementById("userCountMobile");
      const hostIndicatorMobile = document.getElementById(
        "hostIndicatorMobile"
      );
      const backToLobbyMobileBtn = document.getElementById("backToLobbyMobile");
      const shareRoomMobileBtn = document.getElementById("shareRoomMobile");

      const backToLobbyErrorBtn = document.getElementById("backToLobbyError");
      const hostNameEl = document.getElementById("hostName");

      // Desktop elements
      const hostControls = document.getElementById("hostControls");
      const nonHostMessage = document.getElementById("nonHostMessage");
      const youtubeUrlInput = document.getElementById("youtubeUrl");
      const loadVideoBtn = document.getElementById("loadVideo");
      const usersListDesktop = document.getElementById("usersListDesktop");
      const chatMessagesDesktop = document.getElementById(
        "chatMessagesDesktop"
      );
      const chatInputDesktop = document.getElementById("chatInputDesktop");
      const sendMessageDesktop = document.getElementById("sendMessageDesktop");
      const userCountDesktop = document.getElementById("userCountDesktop");
      const userCountInfo = document.getElementById("userCountInfo");
      const rateLimitDesktop = document.getElementById("rateLimitDesktop");
      const rateLimitTimerDesktop = document.getElementById(
        "rateLimitTimerDesktop"
      );

      // Mobile elements
      const hostControlsMobile = document.getElementById("hostControlsMobile");
      const hostControlsInputMobile = document.getElementById(
        "hostControlsInputMobile"
      );
      const youtubeUrlMobile = document.getElementById("youtubeUrlMobile");
      const loadVideoMobileBtn = document.getElementById("loadVideoMobileBtn");
      const usersListMobile = document.getElementById("usersListMobile");
      const chatMessagesMobile = document.getElementById("chatMessagesMobile");
      const chatInputMobile = document.getElementById("chatInputMobile");
      const sendMessageMobile = document.getElementById("sendMessageMobile");
      const userCountMobileTab = document.getElementById("userCountMobileTab");
      const chatTab = document.getElementById("chatTab");
      const usersTab = document.getElementById("usersTab");
      const chatTabContent = document.getElementById("chatTabContent");
      const usersTabContent = document.getElementById("usersTabContent");
      const rateLimitMobile = document.getElementById("rateLimitMobile");
      const rateLimitTimerMobile = document.getElementById(
        "rateLimitTimerMobile"
      );

      // XSS Protection function
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Rate limiting functions
      function checkRateLimit() {
        const now = Date.now();
        const sevenSecondsAgo = now - 7000;
        messageHistory = messageHistory.filter(
          (timestamp) => timestamp > sevenSecondsAgo
        );
        if (messageHistory.length >= 3) {
          return false;
        }
        return true;
      }

      function addToMessageHistory() {
        messageHistory.push(Date.now());
      }

      function showRateLimit() {
        rateLimitActive = true;
        const rateLimitTime = 7;
        let timeLeft = rateLimitTime;

        rateLimitDesktop.classList.remove("hidden");
        rateLimitMobile.classList.remove("hidden");

        sendMessageDesktop.disabled = true;
        sendMessageMobile.disabled = true;
        chatInputDesktop.disabled = true;
        chatInputMobile.disabled = true;

        rateLimitTimerDesktop.textContent = timeLeft;
        rateLimitTimerMobile.textContent = timeLeft;

        rateLimitTimer = setInterval(() => {
          timeLeft--;
          rateLimitTimerDesktop.textContent = timeLeft;
          rateLimitTimerMobile.textContent = timeLeft;

          if (timeLeft <= 0) {
            clearInterval(rateLimitTimer);
            hideRateLimit();
          }
        }, 1000);
      }

      function hideRateLimit() {
        rateLimitActive = false;
        rateLimitDesktop.classList.add("hidden");
        rateLimitMobile.classList.add("hidden");
        sendMessageDesktop.disabled = false;
        sendMessageMobile.disabled = false;
        chatInputDesktop.disabled = false;
        chatInputMobile.disabled = false;
        const now = Date.now();
        messageHistory = messageHistory.filter(
          (timestamp) => timestamp > now - 7000
        );
      }

      // YouTube API Ready callback
      function onYouTubeIframeAPIReady() {
        console.log("üé¨ YouTube API is ready!");
        youtubeApiReady = true;

        if (roomData && roomData.currentVideo) {
          console.log(
            "üé¨ Loading video that was waiting for API:",
            roomData.currentVideo
          );
          loadYouTubeVideo(roomData.currentVideo, false);
        } else {
          displayNoVideoMessage();
        }
      }

      // Detect when YouTube API script is loaded but onYouTubeIframeAPIReady hasn't fired
      let apiCheckInterval = setInterval(() => {
        if (window.YT && window.YT.Player && !youtubeApiReady) {
          console.log(
            "üé¨ YouTube API detected, calling ready function manually"
          );
          onYouTubeIframeAPIReady();
          clearInterval(apiCheckInterval);
        }
      }, 100);

      // Clear the interval after 10 seconds to prevent infinite checking
      setTimeout(() => {
        clearInterval(apiCheckInterval);
      }, 10000);

      // Initialize
      async function init() {
        console.log("üöÄ Initializing room...");

        const storedUser = localStorage.getItem("watchtogether_user");
        if (storedUser) {
          currentUser = JSON.parse(storedUser);
        } else {
          currentUser = {
            username: "Anonymous",
            location: "Earth",
          };
          console.log("üîÑ No stored user data, using defaults:", currentUser);
        }

        const pathParts = window.location.pathname.split("/");
        const roomIdFromUrl = pathParts[pathParts.length - 1].toUpperCase();
        console.log("üö™ Attempting to join room:", roomIdFromUrl);

        socket = io();
        socket.on("connect", () => {
          console.log("‚úÖ Connected to server with socket ID:", socket.id);
          socket.emit("user-connected", currentUser);
          socket.emit("join-room", roomIdFromUrl);
        });

        setupSocketListeners();
        setupEventListeners();
      }

      function setupSocketListeners() {
        socket.on("room-joined", (data) => {
          console.log("‚úÖ Successfully joined room:", data);
          roomData = data.room;
          currentUser.id = data.yourUserId;
          isHost = roomData.host === currentUser.id;

          roomNameEl.textContent = escapeHtml(roomData.name);
          roomIdEl.textContent = roomData.id;
          roomNameMobile.textContent = escapeHtml(roomData.name);
          roomIdMobile.textContent = roomData.id;

          allRoomUsers = data.users || [];
          updateUsersList(allRoomUsers);
          updateHostUI();

          if (roomData.currentVideo && youtubeApiReady) {
            console.log("üé¨ Loading existing video:", roomData.currentVideo);
            loadYouTubeVideo(roomData.currentVideo, false);
          } else if (!roomData.currentVideo) {
            displayNoVideoMessage();
          }

          loadingScreen.classList.add("hidden");
          roomInterface.classList.remove("hidden");

          addChatMessage(
            "system",
            `Welcome to ${roomData.name}! ${allRoomUsers.length} user${
              allRoomUsers.length !== 1 ? "s" : ""
            } in room.`
          );
        });

        socket.on("error", (message) => {
          console.error("‚ùå Room error:", message);
          showError(message);
        });

        socket.on("user-joined", (newUser) => {
          console.log("üë§ User joined:", newUser);
          if (!allRoomUsers.find((u) => u.id === newUser.id)) {
            allRoomUsers.push(newUser);
          }
          updateUsersList(allRoomUsers);
          addChatMessage(
            "system",
            `${escapeHtml(newUser.username)} joined the room.`
          );
        });

        socket.on("user-left", (leftUserId) => {
          const leftUser = allRoomUsers.find((u) => u.id === leftUserId);
          allRoomUsers = allRoomUsers.filter((u) => u.id !== leftUserId);
          updateUsersList(allRoomUsers);
          if (leftUser) {
            addChatMessage(
              "system",
              `${escapeHtml(leftUser.username)} left the room.`
            );
          }
        });

        socket.on("users-updated", (users) => {
          console.log("üë• Users list updated:", users);
          allRoomUsers = users || [];
          updateUsersList(allRoomUsers);
        });

        socket.on("host-changed", (newHostId) => {
          console.log("üëë Host changed to:", newHostId);
          if (roomData) {
            roomData.host = newHostId;
          }
          isHost = currentUser && newHostId === currentUser.id;
          updateHostUI();
          updateUsersList(allRoomUsers);

          const newHostUser = allRoomUsers.find((u) => u.id === newHostId);
          if (newHostUser) {
            if (isHost) {
              addChatMessage("system", "You are now the host of this room.");
            } else {
              addChatMessage(
                "system",
                `${escapeHtml(newHostUser.username)} is now the host.`
              );
            }
          }
        });

        socket.on("chat-message", (message) => {
          console.log("üí¨ Chat received:", message);
          addChatMessage(
            "user",
            message.text,
            message.username,
            message.userId === currentUser.id
          );
        });

        // YouTube sync events
        socket.on("video-play", (data) => {
          if (youtubePlayer && !isHost) {
            console.log("‚ñ∂Ô∏è Received video-play at:", data.time);
            youtubePlayer.seekTo(data.time, true);
            youtubePlayer.playVideo();
          }
        });

        socket.on("video-pause", (data) => {
          if (youtubePlayer && !isHost) {
            console.log("‚è∏Ô∏è Received video-pause at:", data.time);
            youtubePlayer.pauseVideo();
            if (Math.abs(youtubePlayer.getCurrentTime() - data.time) > 1.5) {
              youtubePlayer.seekTo(data.time, true);
            }
          }
        });

        socket.on("video-seek", (data) => {
          if (youtubePlayer && !isHost) {
            console.log("‚è© Received video-seek to:", data.time);
            youtubePlayer.seekTo(data.time, true);
          }
        });

        socket.on("video-change", (data) => {
          console.log("üé¨ Received video-change to:", data.videoId);
          if (youtubeApiReady) {
            loadYouTubeVideo(data.videoId, false);
          } else {
            if (roomData) {
              roomData.currentVideo = data.videoId;
            }
            console.log(
              "üé¨ YouTube API not ready, storing video for later:",
              data.videoId
            );
          }
          addChatMessage("system", `Loading new video...`);
        });

        // Video loading feedback events
        socket.on("video-load-success", (data) => {
          console.log("‚úÖ Video loaded successfully:", data.videoId);
          addChatMessage("success", `‚úÖ Video loaded successfully!`);
          videoLoadingInProgress = false;
        });

        socket.on("video-load-error", (error) => {
          console.error("‚ùå Video load error:", error);
          addChatMessage("error", `‚ùå Video load failed: ${error}`);
          videoLoadingInProgress = false;
          displayNoVideoMessage();
        });

        socket.on("disconnect", (reason) => {
          console.log("üîå Disconnected:", reason);
          addChatMessage(
            "system",
            "Disconnected from server. Attempting to reconnect..."
          );
          if (reason === "io server disconnect") {
            showError("You have been disconnected by the server.");
          }
        });
      }

      function setupEventListeners() {
        backToLobbyBtn.addEventListener("click", leaveRoom);
        backToLobbyMobileBtn.addEventListener("click", leaveRoom);
        backToLobbyErrorBtn.addEventListener("click", () => {
          window.location.href = "/watchparty";
        });

        shareRoomBtn.addEventListener("click", shareRoom);
        shareRoomMobileBtn.addEventListener("click", shareRoom);

        sendMessageDesktop.addEventListener("click", () =>
          sendChatMessage(chatInputDesktop)
        );
        chatInputDesktop.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage(chatInputDesktop);
          }
        });

        sendMessageMobile.addEventListener("click", () =>
          sendChatMessage(chatInputMobile)
        );
        chatInputMobile.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage(chatInputMobile);
          }
        });

        loadVideoBtn.addEventListener("click", () =>
          loadVideoFromInput(youtubeUrlInput)
        );
        youtubeUrlInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") loadVideoFromInput(youtubeUrlInput);
        });

        loadVideoMobileBtn.addEventListener("click", () =>
          loadVideoFromInput(youtubeUrlMobile)
        );
        youtubeUrlMobile.addEventListener("keypress", (e) => {
          if (e.key === "Enter") loadVideoFromInput(youtubeUrlMobile);
        });

        chatTab.addEventListener("click", () => switchTab("chat"));
        usersTab.addEventListener("click", () => switchTab("users"));

        window.addEventListener("beforeunload", () => {
          if (socket && socket.connected) {
            socket.emit("leave-room");
          }
        });
      }

      function leaveRoom() {
        if (socket && socket.connected) {
          socket.emit("leave-room");
        }
        window.location.href = "/watchparty";
      }

      function shareRoom() {
        navigator.clipboard
          .writeText(window.location.href)
          .then(() => {
            const originalText = shareRoomBtn.textContent;
            const originalTextMobile = shareRoomMobileBtn.textContent;

            shareRoomBtn.textContent = "Copied!";
            shareRoomMobileBtn.textContent = "Copied!";

            setTimeout(() => {
              shareRoomBtn.innerHTML = `
              <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"/>
              </svg>
              Share
            `;
              shareRoomMobileBtn.textContent = "Share";
            }, 2000);
          })
          .catch((err) => {
            console.error("Failed to copy room link:", err);
            addChatMessage("error", "Failed to copy room link");
          });
      }

      function switchTab(tab) {
        activeTab = tab;
        chatTab.classList.toggle("active", tab === "chat");
        usersTab.classList.toggle("active", tab === "users");
        chatTabContent.classList.toggle("hidden", tab !== "chat");
        usersTabContent.classList.toggle("hidden", tab !== "users");
      }

      function showError(message) {
        errorMessage.textContent = escapeHtml(message);
        loadingScreen.classList.add("hidden");
        errorScreen.classList.remove("hidden");
      }

      function updateHostUI() {
        if (isHost) {
          hostControls?.classList.remove("hidden");
          nonHostMessage?.classList.add("hidden");
          hostControlsMobile?.classList.remove("hidden");
          hostControlsInputMobile?.classList.remove("hidden");
          hostIndicator?.classList.remove("hidden");
          hostIndicatorMobile?.classList.remove("hidden");
        } else {
          hostControls?.classList.add("hidden");
          nonHostMessage?.classList.remove("hidden");
          hostControlsMobile?.classList.add("hidden");
          hostControlsInputMobile?.classList.add("hidden");
          hostIndicator?.classList.add("hidden");
          hostIndicatorMobile?.classList.add("hidden");
        }
      }

      function sendChatMessage(inputElement) {
        const message = inputElement.value.trim();
        if (!message || rateLimitActive) return;

        if (!checkRateLimit()) {
          showRateLimit();
          return;
        }

        if (socket && socket.connected) {
          socket.emit("chat-message", { text: message });
          addToMessageHistory();
          inputElement.value = "";
        }
      }

      function addChatMessage(type, text, username = "", isOwn = false) {
        const messageDiv = document.createElement("div");
        const sanitizedText = escapeHtml(text);

        if (type === "system") {
          messageDiv.className = "chat-message system";
          messageDiv.innerHTML = `<div class="text-sm">${sanitizedText}</div>`;
        } else if (type === "error") {
          messageDiv.className = "chat-message error";
          messageDiv.innerHTML = `<div class="text-sm">${sanitizedText}</div>`;
        } else if (type === "success") {
          messageDiv.className = "chat-message success";
          messageDiv.innerHTML = `<div class="text-sm">${sanitizedText}</div>`;
        } else {
          messageDiv.className = `chat-message ${isOwn ? "own" : ""}`;
          messageDiv.innerHTML = `
            <div class="flex items-center justify-between mb-1">
              <span class="font-medium text-sm">${escapeHtml(username)}</span>
              <span class="text-xs text-tertiary">${new Date().toLocaleTimeString(
                [],
                {
                  hour: "2-digit",
                  minute: "2-digit",
                }
              )}</span>
            </div>
            <div class="text-sm break-words">${sanitizedText}</div>
          `;
        }

        chatMessagesDesktop?.appendChild(messageDiv.cloneNode(true));
        chatMessagesMobile?.appendChild(messageDiv);

        if (chatMessagesDesktop) {
          chatMessagesDesktop.scrollTop = chatMessagesDesktop.scrollHeight;
        }
        if (chatMessagesMobile) {
          chatMessagesMobile.scrollTop = chatMessagesMobile.scrollHeight;
        }
      }

      function updateUsersList(usersToDisplay) {
        if (!Array.isArray(usersToDisplay)) return;

        const createUserCard = (user) => {
          const userDiv = document.createElement("div");
          userDiv.className = "user-card";
          const isUserHost = roomData && roomData.host === user.id;

          userDiv.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <div class="online-indicator"></div>
                <div>
                  <div class="font-medium text-sm">${escapeHtml(
                    user.username
                  )}</div>
                  ${
                    user.location
                      ? `<div class="text-xs text-secondary">${escapeHtml(
                          user.location
                        )}</div>`
                      : ""
                  }
                </div>
              </div>
              ${isUserHost ? '<span class="host-badge">Host</span>' : ""}
            </div>
          `;

          if (isUserHost && hostNameEl) {
            hostNameEl.textContent = user.username;
          }

          return userDiv;
        };

        if (usersListDesktop) {
          usersListDesktop.innerHTML = "";
          usersToDisplay.forEach((user) => {
            usersListDesktop.appendChild(createUserCard(user));
          });
        }

        if (usersListMobile) {
          usersListMobile.innerHTML = "";
          usersToDisplay.forEach((user) => {
            usersListMobile.appendChild(createUserCard(user));
          });
        }

        const count = usersToDisplay.length;
        const countText = `${count} user${count !== 1 ? "s" : ""}`;

        if (userCountEl) userCountEl.textContent = countText;
        if (userCountDesktop) userCountDesktop.textContent = count;
        if (userCountMobile) userCountMobile.textContent = countText;
        if (userCountMobileTab) userCountMobileTab.textContent = count;
        if (userCountInfo) userCountInfo.textContent = count;
      }

      function showVideoLoading() {
        const loadingHtml = `
          <div class="video-loading">
            <div class="text-center">
              <div class="w-12 h-12 border-2 border-gray-600 border-t-orange-500 rounded-full animate-spin mx-auto mb-4"></div>
              <div class="text-lg font-medium">Loading video...</div>
            </div>
          </div>
        `;

        const desktopPlayer = document.getElementById("youtubePlayer");
        const mobilePlayer = document.getElementById("youtubePlayerMobile");

        if (desktopPlayer) desktopPlayer.innerHTML = loadingHtml;
        if (mobilePlayer) mobilePlayer.innerHTML = loadingHtml;
      }

      function loadYouTubeVideo(videoId, emitChange = true) {
        console.log(`üé¨ Loading YouTube video: ${videoId}. Is host: ${isHost}`);

        if (!youtubeApiReady) {
          console.log("üé¨ YouTube API not ready yet, storing video for later");
          if (roomData) {
            roomData.currentVideo = videoId;
          }
          return;
        }

        if (youtubePlayer && youtubePlayer.destroy) {
          youtubePlayer.destroy();
          youtubePlayer = null;
        }

        // Show loading state
        if (emitChange) {
          showVideoLoading();
          videoLoadingInProgress = true;
        }

        const playerDiv =
          window.innerWidth >= 768 ? "youtubePlayer" : "youtubePlayerMobile";
        console.log(`üé¨ Creating YouTube player in: ${playerDiv}`);

        youtubePlayer = new YT.Player(playerDiv, {
          height: "100%",
          width: "100%",
          videoId: videoId,
          playerVars: {
            autoplay: 0,
            controls: isHost ? 1 : 0,
            disablekb: !isHost ? 1 : 0,
            fs: 1,
            modestbranding: 1,
            rel: 0,
            playsinline: 1,
            origin: window.location.origin,
            enablejsapi: 1,
          },
          events: {
            onReady: (event) => {
              console.log("üé¨ YouTube player ready for video:", videoId);
              if (roomData) {
                roomData.currentVideo = videoId;
              }
              videoLoadingInProgress = false;
            },
            onStateChange: onPlayerStateChange,
            onError: (event) => {
              console.error("YouTube Player Error:", event.data);
              let errorMsg = "An error occurred with the YouTube player.";
              if (event.data === 2) errorMsg = "Invalid YouTube video ID.";
              if (event.data === 100) errorMsg = "Video not found or private.";
              if (event.data === 101 || event.data === 150)
                errorMsg = "Video cannot be embedded.";

              addChatMessage("error", `‚ùå YouTube Error: ${errorMsg}`);

              if (isHost && emitChange) {
                socket.emit("video-load-error", errorMsg);
              }

              videoLoadingInProgress = false;
              displayNoVideoMessage();
            },
          },
        });
      }

      function onPlayerStateChange(event) {
        if (!isHost || !youtubePlayer) return;

        const currentTime = youtubePlayer.getCurrentTime();
        switch (event.data) {
          case YT.PlayerState.PLAYING:
            console.log("‚ñ∂Ô∏è Host played video at:", currentTime);
            socket.emit("video-play", { time: currentTime });
            break;
          case YT.PlayerState.PAUSED:
            console.log("‚è∏Ô∏è Host paused video at:", currentTime);
            socket.emit("video-pause", { time: currentTime });
            break;
        }
      }

      function loadVideoFromInput(inputElement) {
        if (!isHost) {
          addChatMessage("error", "‚ùå Only the host can load videos");
          return;
        }

        if (videoLoadingInProgress) {
          addChatMessage("error", "‚ùå Please wait, video is still loading");
          return;
        }

        const url = inputElement.value.trim();
        if (!url) {
          addChatMessage("error", "‚ùå Please enter a YouTube URL");
          return;
        }

        const videoId = extractYouTubeVideoId(url);
        if (videoId) {
          console.log("üé¨ Host requesting video change to:", videoId);
          socket.emit("video-change", { videoId });
          inputElement.value = "";
          addChatMessage("system", "üîÑ Loading new video...");
          videoLoadingInProgress = true;
        } else {
          addChatMessage(
            "error",
            "‚ùå Invalid YouTube URL. Please use a valid video link."
          );
        }
      }

      function extractYouTubeVideoId(url) {
        const regex =
          /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = url.match(regex);
        return match ? match[1] : null;
      }

      function displayNoVideoMessage() {
        const noVideoHtml = `
          <div class="flex items-center justify-center h-full" style="min-height: 250px;">
            <div class="text-center text-secondary">
              <svg class="w-20 h-20 mx-auto mb-4 text-tertiary" fill="currentColor" viewBox="0 0 24 24">
                <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
              </svg>
              <div class="text-lg font-medium mb-2">No video loaded</div>
              <div class="text-sm">${
                isHost
                  ? "Load a YouTube video to watch together."
                  : "Waiting for the host to load a video."
              }</div>
            </div>
          </div>
        `;

        const desktopPlayer = document.getElementById("youtubePlayer");
        const mobilePlayer = document.getElementById("youtubePlayerMobile");

        if (desktopPlayer) desktopPlayer.innerHTML = noVideoHtml;
        if (mobilePlayer) mobilePlayer.innerHTML = noVideoHtml;
      }

      // Initialize when page loads
      init();
    </script>
  </body>
</html>
